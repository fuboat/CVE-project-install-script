#!/bin/sh

# target exec file: ./libpng/contrib/pngminus/pnm2png

git clone https://github.com/glennrp/libpng.git
cd libpng || exit
git checkout tags/v1.6.34 -f
git clean -xfd

export CFLAGS="-g" LDFLAGS="-lz"

./autogen.sh
./configure
make

cd contrib/pngminus/ || exit
sed -i '5s/.*//' makefile.std
sed -i '16s/.*/PNGLIBS = ..\/..\/.libs\/libpng16.a/' makefile.std
sed -i '22s/.*//' makefile.std
sed -i '23s/.*//' makefile.std
sed -i '24s/.*//' makefile.std
sed -i '27s/.*/CFLAGS=-g -fsanitize=address/' makefile.std


export CFLAGS="-g" LDFLAGS="-lz -fsanitize=address"
make -f makefile.std
cd ../../

mkdir crashes
wget https://raw.githubusercontent.com/fouzhe/security/master/libpng/crash_pnm2png_stack_buffer_overflow_get_token\
     -O crashes/crash_pnm2png_stack_buffer_overflow_get_token
contrib/pngminus/pnm2png crashes/crash_pnm2png_stack_buffer_overflow_get_token 1.png