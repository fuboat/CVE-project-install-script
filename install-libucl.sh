#!/bin/bash

dir=$(cd `dirname $0`;pwd)

rm -rf libucl

git clone https://github.com/vstakhov/libucl
cd libucl || exit
git checkout 0af751def7675c68657a717b3a2686587c84fb09 -f

mkdir build
cd build || exit
cmake ..
make

cd ..
$CC $CFLAGS $CPPFLAGS -c tests/fuzzers/ucl_msgpack_fuzzer.c -I ./include/ -I ./src/  -I ./uthash/ -o ucl_msgpack_fuzzer.o

$CC $CXXFLAGS $CPPFLAGS $LDFLAGS \
ucl_msgpack_fuzzer.o -L ./build/ -lucl -I "$dir"/include "$dir"/others/afl-compiler-rt.o "$dir"/others/aflpp_driver.c -o libucl
