#!/bin/bash

dir=$(cd `dirname $0`;pwd)

rm -rf lightmatrix

git clone https://github.com/zjc666/LightMatrix lightmatrix
cd lightmatrix || exit
git checkout -f 72470e53f653b9e608fdc620fcb7c404b0638938

sed -i "294s/.*/		return 0;/" light_matrix.c

$CC -c $CFLAGS $CPPFLAGS light_matrix.c -o lightmatrix.o

wget https://raw.githubusercontent.com/fuboat/CVE-project-install-script/main/others/lightmatrix--target.c -O target.c
wget https://raw.githubusercontent.com/fuboat/CVE-project-install-script/main/others/FuzzingEngine.a -O FuzzingEngine.a
$CC -c $CFLAGS $CPPFLAGS target.c -o target.o
$CC $CXXFLAGS $CPPFLAGS $LDFLAGS target.o -I "$dir"/include "$dir"/others/afl-compiler-rt.o lightmatrix.o "$dir"/others/aflpp_driver.c -o lightmatrix

# how to run
ASAN_OPTIONS=abort_on_error=1:allocator_may_return_null=1 ./lightmatrix @@