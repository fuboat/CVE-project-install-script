#!/bin/sh

# target exec file: ./jpeg-compressor/encoder

git clone https://github.com/kornelski/jpeg-compressor.git
cd jpeg-compressor || exit
export CXX=clang++
export CXXFLAGS="-fsanitize=address -g"
export LDFLAGS="-fsanitize=address"
sed -i '3s/.*/CXXFLAGS ?= -O0 -lm -fno-signed-zeros/' Makefile
make

mkdir crashes
wget https://raw.githubusercontent.com/fouzhe/security/master/jpeg-compressor/crash_stack_buffer_overflow \
     -O crashes/crash_stack_buffer_overflow
wget https://raw.githubusercontent.com/fouzhe/security/master/jpeg-compressor/crash_heap_buffer_overflow_in_bmp_load \
     -O crashes/crash_heap_buffer_overflow_in_bmp_load

./encoder crashes/crash_stack_buffer_overflow 1.jpeg 50
./encoder crashes/crash_heap_buffer_overflow_in_bmp_load 1.jpeg 50
