#include "util/ut_hopscotch.h"
#include <stdio.h>

extern void dfuzz_init(const char *group);
extern void dfuzz_get_next_input(void **buf, unsigned long *len);


struct ut_hh *seq_hash;

typedef struct hash_node {
	int64_t seq;
}hash_node;

static uint32_t node_hash (const void *vn)
{
	const struct hash_node *n = vn;
	/* we hash the lower 32 bits, on the assumption that with 4 billion
	 *    samples in between there won't be significant correlation */
	const uint64_t c = UINT64_C(16292676669999574021);
	const uint32_t x = (uint32_t) n->seq;
	return (unsigned) ((x * c) >> 32);
}

static int node_eq (const void *va, const void *vb)
{
	const struct hash_node *a = va;
	const struct hash_node *b = vb;
	return a->seq == b->seq;
}

int main(){
	dfuzz_init("ut_hopscotch");

	void *buf;
	size_t len;

	while(1) {
		dfuzz_get_next_input(&buf, &len);
		seq_hash = ut_hhNew(32, node_hash, node_eq);
		for(unsigned long i = 0; i < len; i++) {
			uint8_t value = ((uint8_t *)buf)[i];
			hash_node *tmp =(hash_node*)malloc(sizeof(hash_node));
			tmp->seq = value;
			ut_hhAdd (seq_hash, tmp);
		}
		for(unsigned long i = 0; i < len; i++) {
			uint8_t value = ((uint8_t *)buf)[i];
			hash_node t;
			t.seq = value;
			hash_node *p = ut_hhLookup(seq_hash, &t);
			ut_hhRemove(seq_hash, &t);
			free(p);
		}
		ut_hhFree(seq_hash);
	}
	return 0;
}

