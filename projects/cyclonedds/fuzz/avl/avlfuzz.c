#include "util/ut_avl.h"
#include <stdio.h>

extern void dfuzz_init(const char *group);
extern void dfuzz_get_next_input(void **buf, unsigned long *len);

typedef struct avl_fuzz_node
{
  ut_avlNode_t avlnode;
  int key;
} avl_fuzz_node;

static int avl_fuzz_compare (const int * a, const int * b)
{
  return (*a == *b) ? 0 : (*a < *b) ? -1 : 1;
}

const ut_avlTreedef_t fuzz_tree_def = UT_AVL_TREEDEF_INITIALIZER
(
  offsetof (avl_fuzz_node, avlnode),
  offsetof (avl_fuzz_node, key),
  (int (*) (const void *, const void *)) avl_fuzz_compare,
  0
);


int main() {
    dfuzz_init("ut_avl");
    void *buf;
    size_t len;

    while(1) {
        dfuzz_get_next_input(&buf, &len);
        ut_avlTree_t t;
        ut_avlInit (&fuzz_tree_def, &t);

        for(unsigned long i = 0; i < len; i++) {
            int value = ((uint8_t *)buf)[i];
            ut_avlIPath_t path;

            if (ut_avlLookupIPath (&fuzz_tree_def, &t, &value, &path) == NULL) {
                avl_fuzz_node *tmp = (avl_fuzz_node *)malloc(sizeof(avl_fuzz_node));
                tmp->key = value;
                ut_avlInsertIPath (&fuzz_tree_def, &t, tmp, &path);
            }
        }
        ut_avlIter_t it;
        for(avl_fuzz_node * m= ut_avlIterFirst(&fuzz_tree_def, &t, &it); m != NULL; m=ut_avlIterNext(&it)) {
            // printf("key is %d\n",m->key);
        }
        ut_avlFree(&fuzz_tree_def, &t, free);
    }
    return 0;
}