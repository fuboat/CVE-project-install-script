#!/bin/bash

rm -rf pdfalto

apt install libtiff-dev
apt install libfreetype6-dev
apt install libpng12-dev
apt install libxml2-dev
apt install libpaper-dev

git clone https://github.com/kermitt2/pdfalto.git
cd pdfalto || exit
git checkout tags/0.1 -f
git submodule update --init --recursive
sed -i '40s/.*/    target_link_libraries(pdfalto png ${PNG_SUBDIR}\/libpng.a zlib ${ZLIB_SUBDIR}\/libzlib.a paper xml2 xpdf ${XPDF_BUILD_DIR}\/xpdf\/lib\/libxpdf.a goo fofi ${HAVE_PAPER_H})/' CMakeLists.txt
sed -i '42s/.*/    target_link_libraries(pdfalto png ${PNG_SUBDIR}\/libpng.a zlib ${ZLIB_SUBDIR}\/libzlib.a paper xml2 xpdf ${XPDF_BUILD_DIR}\/xpdf\/lib\/libxpdf.a goo fofi )/' CMakeLists.txt

cmake .
make


mkdir crashes
wget https://raw.githubusercontent.com/grandnew/software-vulnerabilities/master/pdfalto/heap-buffer-overflow_dump \
     -O crashes/heap-buffer-overflow_dump
./pdfalto crashes/heap-buffer-overflow_dump 1.xml
# 这个 crash 无法复现，原因不明