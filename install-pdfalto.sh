#!/bin/bash

sudo apt install libtiff-dev
sudo apt install libfreetype6-dev
sudo apt install libpng12-dev
sudo apt install libxml2

git clone https://github.com/kermitt2/pdfalto.git
cd pdfalto || exit
git checkout tags/0.1 -f
git submodule update --init --recursive
sed -i '40s/.*/    target_link_libraries(pdfalto png ${PNG_SUBDIR}\/libpng.a zlib ${ZLIB_SUBDIR}\/libzlib.a paper xml2 xpdf ${XPDF_BUILD_DIR}\/xpdf\/lib\/libxpdf.a goo fofi ${HAVE_PAPER_H})/' CMakeLists.txt
sed -i '42s/.*/    target_link_libraries(pdfalto png ${PNG_SUBDIR}\/libpng.a zlib ${ZLIB_SUBDIR}\/libzlib.a paper xml2 xpdf ${XPDF_BUILD_DIR}\/xpdf\/lib\/libxpdf.a goo fofi )/' CMakeLists.txt

CMAKE_C_COMPILER="clang" \
CMAKE_CXX_COMPILER="clang++" \
CMAKE_CXX_FLAGS="-fsanitize=address -g" \
CMAKE_C_FLAGS="-fsanitize=address" \
CMAKE_EXE_LINKER_FLAGS="-fsanitize=address" \
cmake .
make


mkdir crashes
wget https://raw.githubusercontent.com/grandnew/software-vulnerabilities/master/pdfalto/heap-buffer-overflow_dump \
     -O crashes/heap-buffer-overflow_dump
./pdfalto crashes/heap-buffer-overflow_dump 1.xml